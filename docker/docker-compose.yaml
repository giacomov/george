version: '3.3'

services:
  
  logger:
    build:
      context: .
      dockerfile: Dockerfile.ros2
    # platform: linux/arm64
    # network_mode: host
    command: bash -c "source /opt/ros/eloquent/setup.bash && ros2 run demo_nodes_cpp listener"
    healthcheck:
      test: ros2 node info /listener || exit 1
      interval: 1s
      timeout: 5s
      retries: 10
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_LOCALHOST_ONLY=0
  
  whisper:
    build:
      context: ..
      dockerfile: docker/Dockerfile.whisper    
    command: bash -c "sleep 10 && source /opt/ros/eloquent/setup.bash && source /whisper/voice_commands/install/setup.bash && ros2 run voice_commands stream_listener"
    devices:
      - /dev/snd:/dev/snd
    depends_on:
      - logger

  # talker:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.ros2
  #   # platform: linux/arm64
  #   # network_mode: host
  #   command: bash -c "source /opt/ros/eloquent/setup.bash && ros2 run demo_nodes_cpp talker"
  #   environment:
  #     - ROS_DOMAIN_ID=0
  #     - ROS_LOCALHOST_ONLY=0

  navigation:
    build:
      context: ..
      dockerfile: docker/Dockerfile.navigation
    # platform: linux/arm64
    # network_mode: host
    command: bash -c "sleep 10 && source /opt/ros/eloquent/setup.bash && source /navigation/navigation/install/setup.bash && ros2 run navigation interpreter"
    environment:
      - ROS_DOMAIN_ID=0
      - ROS_LOCALHOST_ONLY=0
    depends_on:
      - whisper
      - logger
  
  # check:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.ros2
  #   # platform: linux/arm64
  #   # network_mode: host
  #   command: bash -c "source /opt/ros/eloquent/setup.bash && while sleep 10; do echo Topic list ; ros2 topic list; done"
  #   environment:
  #     - ROS_DOMAIN_ID=0
  #     - ROS_LOCALHOST_ONLY=0
  #     - TERM=xterm
  #   depends_on:
  #     - whisper
  #     - listener

